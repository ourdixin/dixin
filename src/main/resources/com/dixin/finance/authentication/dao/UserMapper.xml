<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dixin.finance.authentication.dao.UserMapper">

  <!-- cache / 暂时去掉缓存，等后台可以操作的时候再加上缓存 -->
  
  <insert id="insert" parameterType="com.dixin.finance.authentication.vo.UserVO" >
    insert into User(
		user_name,
		password,
		user_type,
		enabled,
		reg_date,
		name,
		mobile,
		area_id,
		address,
		zip_code,
		qq,
		id_card,
		account,
		institution_id,
		start_date,
		term,
		auth_type,
		fm_id,
		create_user,
		create_time,
		update_user,
		update_time)
	values(
		#{userName},
		PASSWORD(#{password}),
		#{userType},
		#{enabled},
		SYSDATE(),
		#{name},
		#{mobile},
		#{areaId},
		#{address},
		#{zipCode},
		#{qq},
		#{idCard},
		#{account},
		#{institutionId},
		#{startDate},
		#{term},
		#{authType},
		#{fmId},
		0,
		SYSDATE(),
		0,
		SYSDATE()
	)
  </insert>
    
  <select id="query" parameterType="com.dixin.finance.authentication.vo.UserVO" resultType="com.dixin.finance.authentication.vo.UserVO">
    SELECT 
    	id id,
	    user_name userName,
	    password password,
	    user_type userType,
	    enabled enabled,
	    reg_date regDate,
	    name name,
	    mobile mobile,
	    area_id areaId,
	    address address,
	    zip_code zipCode,
	    qq qq,
	    id_card idCard,
	    account account,
	    institution_id institutionId,
	    start_date startDate,
	    term term,
	    auth_type authType,
	    fm_id fmId,
	    create_user createUser,
	    create_time createTime,
	    update_user updateUser,
	    update_time updateTime
	FROM
	    user
  </select>
  
  <select id="selectLoginUser" parameterType="map" resultType="com.dixin.finance.authentication.vo.UserVO">
    SELECT 
    	id id,
	    user_name userName,
	    password password,
	    user_type userType,
	    enabled enabled,
	    reg_date regDate,
	    name name,
	    mobile mobile,
	    area_id areaId,
	    address address,
	    zip_code zipCode,
	    qq qq,
	    id_card idCard,
	    account account,
	    institution_id institutionId,
	    start_date startDate,
	    term term,
	    auth_type authType,
	    fm_id fmId,
	    create_user createUser,
	    create_time createTime,
	    update_user updateUser,
	    update_time updateTime
	FROM
	    user
	WHERE 
		password=PASSWORD(#{password}) and (user_name = #{userName} or mobile= #{userName} )
  </select>
  
	<!-- 更新用户信息 -->
	<update id="updateUser" parameterType="com.dixin.finance.authentication.vo.UserVO">
		UPDATE user SET 
		<if test="password!=null">
			password=#{password},
		</if>
		<if test="mobile!=null">
			mobile=#{mobile},
		</if>
		<if test="area!=null">
			area_id=#{area.id},
		</if>
		<if test="address!=null">
			address=#{address},
		</if>
		<if test="zipCode!=null">
			zip_code=#{zipCode},
		</if>
		<if test="qq!=null">
			qq=#{qq},
		</if>
		<if test="account!=null">
			account=#{account},
		</if>
		<if test="institutionId!=null">
			institution_id=#{institutionId},
		</if>
		update_user=0,
		update_time=SYSDATE()
		WHERE id=#{id}
	</update>
  
  
  
	<!-- 删除用户 -->
	<delete id="deleteStudent" parameterType="int">
			DELETE FROM user WHERE id = #{userId}
	</delete>
  	
  	<resultMap  id="f_inResult" type="com.dixin.finance.authentication.vo.Financial_institutionVO">
		<id column="id" property="id"/>
		<result column="name" property="name"/>
		<result column="tel" property="tel"/>
	</resultMap>
	
	<resultMap id="userResult" type="com.dixin.finance.authentication.vo.UserVO">  
		<id column="id" property="id"/>
		<result column="user_name" property="userName"/>
		<result column="password" property="password"/>
		<result column="user_type" property="userType"/>
		<result column="name" property="name"/>
		<result column="mobile" property="mobile"/>
		<result column="address" property="address"/>
		<result column="zip_code" property="zipCode"/>
		<result column="qq" property="qq"/>
		<result column="account" property="account"/>
		<result column="start_date" property="startDate"/>
		<result column="term" property="term"/>
		<result column="update_user" property="update_user"/>
		<result column="update_time" property="update_time"/>
		<association property="financialInstitution" column="institution_id" resultMap="f_inResult"/>
	</resultMap>  
	
	<!-- 通过id 查找用户 -->
	<select id="findUserById" parameterType="int" resultMap="userResult">
		SELECT u.*
		FROM
	    user u left join financial_institution f on u.institution_id = f.id WHERE u.id = #{userId}
	</select>
  	
  	<!-- 更改用户密码 -->
  	<update id="updatePassword" parameterType="map">
  			UPDATE user SET password = PASSWORD(#{password}) WHERE id=#{user_id}
  	</update>
  	
  	<!-- 查找手机号是否存在，并返回用户 -->
  	<select id="existsTel" parameterType="String" resultType="Integer">
  		   SELECT id FROM user WHERE mobile = #{mobile}
  	</select>
  
  
  
  
</mapper>